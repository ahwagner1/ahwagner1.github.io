---
layout: default
title: "UART"
---

# UART
UART was really the first big milestone I wanted to tackle in terms of learning embedded development.

It's probably the most simple serial communication protocol, and widely used.
Or at least I think it's widely used since almost every embedded job posting I've seen mentions UART.

To start off my journey, I wanted to just setup a single one way communication line between my two nucleo boards.
Once that is done, I'll take it a step further and do two way communication with interrupts as well.
I figure that should get me exposed to interrupts which seem massively important in embedded development,
as well as a solid UART foundation moving forward.

After setting up one and two way communication, I'm not sure what the next UART project would be.
Probably some sort of UART communication shell between a computer and the STM32 but not sure on that one yet

# one-way-comm
This wasn't as hard to setup as I thought it would be. 
I mean it took me a really long time to blink a led based on external input so I figured this was going to take forever.
I really just started by reading the USART section in the STM32F401 reference manual and working from there.

STM really does a pretty good job of giving a general overview of how USART works and what needs to be done to set it up.

I ended up using:
- USART1
- HSI Clock (16MHz on my boards)
- 9600 baud
- 8 data bits, 1 stop bit, no parity
- 16x oversampling

Why those UART settings? 

At work, I've setup countless 9600 baud putty sessions so I guess it stuck with me.
Plus 9600 baud with 16 oversampling should be trivial using the 16 MHz HSI clock.
And I'm not sending anything important over the wire so I wasn't super concerned with setting up parity.

USART1 uses the alternate functions on pins PA9 and PA10 for TX and RX respectivily.
With this in mind, the first step I knew I needed to do was enable the clocks for USART and GPIOA.

With the clocks enabled, I then setup pins PA9 and PA10 to use their alternate functions.

And then finally I configured USART1 to the above specs.

Here you can see the physical layout I setup:

![uart setup](/assets/images/uart-one-way-setup.png)

With the boards setup, and flashed, I needed to test to make sure things were working as intended.

I grappled on the best ways to test things to make sure they were working and settled on a mix of logic analyzer and LEDs.

I used my saleae to monitor the TX line and make sure the right data was being sent of the wire.
On the RX side of things, when the USART1 data register is read from, I briefly flash the onboard led (LD2).
In between every full message sent, I introduce a delay of roughly 600ms just to make things easier to see in the logic analyzer.

I am sending the message "TEST123\n" across the wire:

![saleae screenshot](/assets/images/uart-one-way-saleae.png)

As you can see, we are successfully sending the data "54 45 53 54 31 32 33 0A". This does in fact translate to TEST123\n!
So we know the TX side of things is working, how about RX?

Well you're just gonna have to take my word that it is working.
With the led setup I'm using, it flashes so briefly, it is barely visible and I doubt my phone camera would pick it up.
But I do promise that the data is being read and the led is flashing.

So what's next?

Two way communication is naturally the next step. I can reuse a lot of the code, but I do need to plan how to implement things.

I want to work with interrupts in order to more efficiently implement UART. 
Currently, with the one way communication, I'm just polling and ONLY doing UART.
This isn't realistic and in the two way communication project, I plan on having UART communication happen when an interrupt is generated.
This should simulate a more realistic project and should keep my somewhat busy as I read up on how interrupts work on STM32s.
